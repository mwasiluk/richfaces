<!DOCTYPE html>
<!--
  JBoss, Home of Professional Open Source
  Copyright 2015, Red Hat, Inc. and individual contributors
  by the @authors tag. See the copyright.txt in the distribution for a
  full listing of individual contributors.

  This is free software; you can redistribute it and/or modify it
  under the terms of the GNU Lesser General Public License as
  published by the Free Software Foundation; either version 2.1 of
  the License, or (at your option) any later version.

  This software is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
  Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public
  License along with this software; if not, write to the Free
  Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
  02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:a4j="http://richfaces.org/a4j"
      xmlns:rich="http://richfaces.org/rich">

    <ui:composition template="/layout/template.xhtml">

        <ui:param name="title" value="Push Message Consumer" />
        <!-- content -->
        <ui:define name="content">

            <script>
                $(window).load(function () {
                    handler.init();
                });

                var handler = function () {
                    var running, $output, $panel, origBgColor, queue;
                    function _animatedSetText(event, callback) {
                        running = true;
                        console.log('running set, running ' + running);
                        $panel.animate({opacity: 0.6}, 200, function () {
                            $panel.css('background-color', '#f0f8ff');

                            // set text
                            $output.text(event.rf.data);

                            $panel.animate({opacity: 0.4}, 100, function () {
                                $panel.css('background-color', origBgColor);

                                $panel.animate({opacity: 1}, 300, function () {
                                    running = false;
                                    callback();
                                });
                            });
                        });
                    }
                    function _execute() {
                        if (!!queue.length) {
                            _animatedSetText(queue.splice(0, 1)[0], _execute);
                        }
                    }
                    return {
                        init: function () {
                            queue = [];
                            running = false;
                            $output = $('*[id$=outputDate]');
                            $panel = $('*[id$=panel]');
                            origBgColor = $panel.css('background-color');
                        },
                        process: function (event) {
                            queue.push(event);
                            console.log(queue);
                            if (!running) {
                                _execute();
                            }
                        }
                    };
                }();
            </script>

            <h:form>
                <a4j:commandButton value="Push!" action="#{richBean.push}" disabled="#{!richBean.pushEnabled}" />
                <a4j:commandButton value="Re-render push" render="push" />
                <a4j:commandButton
                    value="#{richBean.pushEnabled ? 'Disable push' : 'Enable push'}"
                    render="@form">
                    <a4j:param assignTo="#{richBean.pushEnabled}" value="#{!richBean.pushEnabled}" />
                </a4j:commandButton>


                <a4j:push id="push"
                          address="#{richBean.address}"
                          ondataavailable="handler.process(event)"
                          rendered="#{richBean.pushEnabled}"
                          />
                <br />
                <br />
                <rich:panel id="panel" style="width: 50%; text-align: center;">
                    Received date: <h:outputText id="outputDate" value="#{richBean.date}"/>
                </rich:panel>
            </h:form>

        </ui:define>

    </ui:composition>

</html>